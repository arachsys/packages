require python

check() {
  url https://curl.haxx.se/download/
  match curl 8.17.0 'curl-([0-9.]+)\.tar'

  url https://github.com/rockdaboot/libpsl/tags
  match libpsl 0.21.5 'tags/([0-9.]+)\.tar'

  url https://github.com/nghttp2/nghttp2/tags
  match nghttp2 1.68.0 'tags/v([0-9.]+)\.tar'

  url https://github.com/ngtcp2/ngtcp2/tags
  match ngtcp2 1.19.0 'tags/v([0-9.]+)\.tar'

  url https://github.com/ngtcp2/nghttp3/tags
  match nghttp3 1.14.0 'tags/v([0-9.]+)\.tar'
}

prepare() {
  unpack https://curl.haxx.se/download/curl-8.17.0.tar.xz
  unpack -d libpsl \
    https://github.com/rockdaboot/libpsl/releases/download/0.21.5/libpsl-0.21.5.tar.gz
  unpack -d nghttp2 \
    https://github.com/nghttp2/nghttp2/releases/download/v1.68.0/nghttp2-1.68.0.tar.xz
  unpack -d ngtcp2 \
    https://github.com/ngtcp2/ngtcp2/releases/download/v1.19.0/ngtcp2-1.19.0.tar.xz
  unpack -d nghttp3 \
    https://github.com/ngtcp2/nghttp3/releases/download/v1.14.0/nghttp3-1.14.0.tar.xz
  apply perl.diff
  tree 7c65633c937c77309b61716c7d390f82f60eb51c02ace8b3c1e7e8ed2d3a52b4
}

build() {
  cd /src/libpsl
  auto-config --prefix=/tmp --disable-shared --enable-builtin --with-pic
  make install

  cd /src/nghttp2
  auto-config --prefix=/tmp --disable-shared --enable-lib-only --with-pic
  make install

  cd /src/nghttp3
  auto-config --prefix=/tmp --disable-shared --enable-lib-only --with-pic
  make install

  cd /src/ngtcp2
  auto-config --prefix=/tmp --disable-shared --enable-lib-only --with-pic \
    LIBNGHTTP3_CFLAGS=-I/tmp/lib/includes LIBNGHTTP3_LIBS=-L/tmp/lib \
    OPENSSL_CFLAGS=-I/lib/include OPENSSL_LIBS=-lssl
  make install

  cd /src
  auto-config --disable-docs --disable-manual --enable-ipv6 \
    --without-ca-bundle --without-ca-path --with-ca-fallback \
    --with-nghttp2 --with-nghttp3 --with-ngtcp2 --with-openssl \
    CPPFLAGS='-DUSE_NGHTTP3=1 -DUSE_NGTCP2=1 -I/tmp/lib/include' \
    LDFLAGS=-L/tmp/lib LIBS='-lnghttp3 -lngtcp2 -lngtcp2_crypto_libressl' \
    PATH_SEPARATOR=: USE_NGHTTP3=1 USE_NGTCP2=1
  make install DESTDIR=/dst
  rm -f /dst/bin/curl-config /dst/bin/wcurl /dst/lib/aclocal/libcurl.m4
}
