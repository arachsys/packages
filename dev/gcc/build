mode autotools

prepare() {
  unpack https://ftp.gnu.org/gnu/binutils/binutils-2.34.tar.xz
  unpack https://ftp.gnu.org/gnu/gcc/gcc-10.2.0/gcc-10.2.0.tar.xz
  unpack -d gmp https://ftp.gnu.org/gnu/gmp/gmp-6.2.0.tar.xz
  unpack -d isl http://isl.gforge.inria.fr/isl-0.22.1.tar.xz
  unpack -d mpc https://ftp.gnu.org/gnu/mpc/mpc-1.1.0.tar.gz
  unpack -d mpfr https://ftp.gnu.org/gnu/mpfr/mpfr-4.1.0.tar.xz

  apply execinfo.patch
  apply no-toollib.patch
  apply paths.patch
  apply pure64.patch
  apply rpath.patch

  tree c5827a5b39aa784218e0a86d92c79d5c9df72d624ea0aacdedfa51fbbbc43e4d
}

config-extra --disable-bootstrap --disable-libsanitizer --disable-libssp \
  --disable-libstdc++-pch --disable-multilib --disable-symvers \
  --disable-werror --enable-__cxa_atexit --enable-clocale=gnu \
  --enable-default-{pie,ssp} --enable-deterministic-archives \
  --enable-languages=c,c++,lto --enable-linker-build-id --enable-plugins \
  --enable-shared --enable-threads=posix --without-local-prefix \
  --with-gxx-include-dir='${prefix}/lib/include/c++/${gcc_version}' \
  --with-isl --with-lib-path=/lib:/lib/shared:/lib/static \
  --with-linker-hash-style=gnu --with-native-system-header-dir=/lib/include \
  --with-slibdir='${prefix}/lib/shared' --with-system-zlib \
  libat_cv_have_ifunc=no

if enabled bootstrap; then
  config-extra --enable-bootstrap
fi

if enabled gold; then
  config-extra --enable-gold
fi

compile-extra tooldir='${prefix}'
install-extra tooldir='${prefix}'

post-config() {
  # Packaging error in binutils 2.34 unconditionally requires texinfo
  sed -e '/^MAKEINFO/s/=.*/= true/' -i Makefile
}

post-install() {
  local TARGET=$(cd $DST/lib/gcc && echo *)
  local VERSION=$(cd $DST/lib/gcc/$TARGET && echo *)
  make -C host-$TARGET/libctf install DESTDIR=$DST
  cp include/libiberty.h $DST/lib/include/
  mkdir -p $DST/lib/bfd-plugins
  ln -s ../gcc/$TARGET/$VERSION/liblto_plugin.so $DST/lib/bfd-plugins/
  mv $DST/lib/**/*.spec $DST/lib/gcc/$TARGET/$VERSION/
  rm -f $DST/bin/{$TARGET-*,ld.bfd,gccbug} $DST/**/*.py
  ln -s gcc $DST/bin/cc
}
