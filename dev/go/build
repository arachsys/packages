enable unstripped
require go

prepare() {
  unpack https://dl.google.com/go/go1.15.src.tar.gz
  apply fmt.patch
  apply paths.patch
  tree 743f139084a15923b465a610a899e89eb6a1a16a7ae5c14f122d8c12802506cf
}

build() {
  GO_LDSO=/lib/ld.so GOCACHE=$SRC/pkg/obj/go-build GOROOT_FINAL=/lib/go \
    bash -c 'cd src && source make.bash --no-banner'

  mkdir -p $DST/{bin,lib/go}
  cp -d -R bin pkg src $DST/lib/go
  ln -s ../lib/go/bin/{go,gofmt} $DST/bin/

  rm -f -r $DST/lib/go/{pkg/obj,pkg/bootstrap,pkg/tool/*/api}
  rm -f -r $DST/lib/go/src/**/{*_test.go,*.bat,*.rc,testdata/}
  strip --strip-unneeded $DST/lib/go/{bin/*,pkg/tool/*/*}
  chmod a+x $DST/lib/go/**/*.{bash,sh}
}
