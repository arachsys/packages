require rust
[[ $CHOST == aarch64-* ]] && require dtc

check() {
  url https://github.com/firecracker-microvm/firecracker/tags
  match version 1.4.1 'tags/v([0-9.]+)\.tar'
}

prepare() {
  unpack firecracker-1.4.1.tar.gz \
    https://github.com/firecracker-microvm/firecracker/archive/refs/tags/v1.4.1.tar.gz
  apply cosmetic.diff
  apply direct.diff
  apply getrandom.diff
  apply logger.diff
  apply seccomp.diff
  apply serial.diff

  ln resources/seccomp/aarch64-{unknown,arachsys}-linux-musl.json
  ln resources/seccomp/x86_64-{unknown,arachsys}-linux-musl.json

  mkdir -p .cargo && rm -f .cargo/config .cargo/config.toml
  cargo vendor >.cargo/config
  sed -i -E 'H;1h;$!d;x;s/("files"\s*:\s*\{)("([^"\\]|\\.)*"|[^"}])*/\1/' \
    vendor/*/.cargo-checksum.json
  tree d6ac5779f9b3a34a3c1d6cbdd18f6e5b3bb3965c591d45b1881d00ab31143658
}

build() {
  LIBCLANG_PATH=/lib/shared cargo build --bin firecracker --release
  install -s -D target/release/firecracker /dst/bin/firecracker
}
