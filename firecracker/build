require rust
[[ $CHOST == aarch64-* ]] && require dtc

check() {
  url https://github.com/firecracker-microvm/firecracker/releases
  match version 1.1.0 'tags/v([0-9.]+)\.tar'
}

prepare() {
  unpack firecracker-1.1.0.tar.gz \
    https://github.com/firecracker-microvm/firecracker/archive/refs/tags/v1.1.0.tar.gz
  apply seccomp.diff
  ln resources/seccomp/aarch64-{unknown,arachsys}-linux-musl.json
  ln resources/seccomp/x86_64-{unknown,arachsys}-linux-musl.json
  mkdir -p .cargo && HOME=/tmp cargo vendor >.cargo/config
  tree 54db07ba6e29cd09d9b9621e2fe0831d9eaca57562e6edb052ac14181d79c18b
}

build() {
  HOME=/tmp LIBCLANG_PATH=/lib/shared cargo build --bin firecracker --release
  install -s -D target/release/firecracker /dst/bin/firecracker
}
