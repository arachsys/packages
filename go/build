enable unstripped
require go

prepare() {
  unpack https://golang.org/dl/go1.16.4.src.tar.gz
  apply fmt.patch
  apply paths.patch
  tree 13f787b0460d66eb51ee83fad7c408f93aa7b51dd188447d0656d5e8486ddc9c
}

build() {
  GO_LDSO=/lib/ld.so GOCACHE=/src/pkg/obj/go-build GOROOT_FINAL=/lib/go \
    CC=cc bash -c 'cd src && source make.bash --no-banner'

  mkdir -p /dst/{bin,lib/go}
  cp -d -R bin pkg src /dst/lib/go
  ln -s ../lib/go/bin/{go,gofmt} /dst/bin/

  rm -f -r /dst/lib/go/{pkg/obj,pkg/bootstrap,pkg/tool/*/api}
  rm -f -r /dst/lib/go/src/**/{*_test.go,*.bat,*.rc,testdata/}
  strip --strip-unneeded /dst/lib/go/{bin/*,pkg/tool/*/*}
  chmod a+x /dst/lib/go/**/*.{bash,sh}
}
