require rust

check() {
  url https://github.com/helix-editor/helix/tags
  match version 23.03 'tags/([0-9.]+)\.tar'
}

prepare() {
  unpack https://github.com/helix-editor/helix/releases/download/23.03/helix-23.03-source.tar.xz
  mkdir -p .cargo && rm -f .cargo/config .cargo/config.toml
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL=sparse cargo vendor >.cargo/config
  find runtime/grammars -xtype l -delete -or -type l -lname '/*' -delete
  maybe rm -f -r -- **/.git
  apply cosmetic.diff
  apply grammars.diff
  tree eec891642b838e97d1d37ec490641a3d2d4243c45eda0bffeb3f1e01a76b6919
}

build() {
  cargo build --release
  mkdir -p /dst/bin /dst/lib/helix/runtime/grammars
  install -s target/release/hx /dst/lib/helix/hx
  install -s runtime/grammars/*.so /dst/lib/helix/runtime/grammars
  cp -R runtime/!(grammars) /dst/lib/helix/runtime
  ln -s ../lib/helix/hx /dst/bin/hx
}
