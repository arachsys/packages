require rust

check() {
  url https://github.com/helix-editor/helix/tags
  match version 23.03 'tags/([0-9.]+)\.tar'
}

prepare() {
  unpack https://github.com/helix-editor/helix/releases/download/23.03/helix-23.03-source.tar.xz
  mkdir -p .cargo && rm -f .cargo/config .cargo/config.toml
  CARGO_REGISTRIES_CRATES_IO_PROTOCOL=sparse cargo vendor >.cargo/config
  sed -i -E 'H;1h;$!d;x;s/("files"\s*:\s*\{)("([^"\\]|\\.)*"|[^"}])*/\1/' \
    vendor/*/.cargo-checksum.json

  find runtime/grammars -xtype l -delete -or -type l -lname '/*' -delete
  maybe rm -f -r -- **/.git

  sed -E -e 's/^\s*(([^"#]|"([^"\\]|\\.)*"|'"'[^']*'"')*)#.*/\1/' \
    -e 's/\s+$//;/^$/d' -i languages.toml *theme.toml runtime/themes/*.toml
  sed -i '2,$s/^\[/\n\0/' languages.toml *theme.toml runtime/themes/*.toml

  sed -E -i '/indent\s*=/s/(tab-width\s*=\s*)[0-9]+/\18/' languages.toml
  rename -a '_' '-' runtime/themes/*.toml

  apply cosmetic.diff
  apply getrandom.diff
  apply grammars.diff
  tree 9dcd97ad208a3c852bc74a3f35cbd069531345bc2331870b58f1f136bc53e420
}

build() {
  cargo build --release
  mkdir -p /dst/bin /dst/lib/helix/runtime/grammars
  install -s target/release/hx /dst/lib/helix/hx
  install -s runtime/grammars/*.so /dst/lib/helix/runtime/grammars
  cp -R runtime/!(grammars) /dst/lib/helix/runtime
  maybe rm -f -- /dst/lib/helix/**/README.md
  ln -s ../lib/helix/hx /dst/bin/hx
}
