require m4 perl

check() {
  url https://codeberg.org/ipmitool/ipmitool/tags
  match version 1.8.19 'archive/IPMITOOL_([0-9]+)_([0-9]+)_([0-9]+)\.tar' '\1.\2.\3'

  url https://ftp.nluug.nl/pub/gnu/autoconf/
  match autoconf 2.72 'autoconf-([0-9.]+)\.tar'

  url https://ftp.nluug.nl/pub/gnu/automake/
  match automake 1.18.1 'automake-([0-9.]+)\.tar'

  url https://ftp.nluug.nl/pub/gnu/libtool/
  match libtool 2.5.4 'libtool-([0-9.]+)\.tar'

  url https://distfiles.ariadne.space/pkgconf/
  match pkgconf 2.5.1 'pkgconf-([0-9.]+)\.tar'
}

prepare() {
  unpack ipmitool-20240628.tar.gz \
    https://codeberg.org/ipmitool/ipmitool/archive/eb1df8d6.tar.gz
  curl -o enterprise-numbers.gz -L \
    https://ftp.openbsd.org/pub/OpenBSD/distfiles/enterprise-numbers.20220204.gz
  gunzip enterprise-numbers.gz

  unpack -d tools/autoconf \
    https://ftp.nluug.nl/pub/gnu/autoconf/autoconf-2.72.tar.xz
  unpack -d tools/automake \
    https://ftp.nluug.nl/pub/gnu/automake/automake-1.18.1.tar.xz
  unpack -d tools/libtool \
    https://ftp.nluug.nl/pub/gnu/libtool/libtool-2.5.4.tar.xz
  unpack -d tools/pkgconf \
    https://distfiles.ariadne.space/pkgconf/pkgconf-2.5.1.tar.xz

  apply console.diff
  apply lanplus.diff
  tree 2713daa2bc8efb763f67dd382854c71a2d018394410a321b8933053e7f57c102
}

build() {
  export PATH=$PATH:/tmp/bin

  for TOOL in autoconf automake libtool pkgconf; do
    cd /src/tools/$TOOL
    auto-config --prefix=/tmp
    make install
  done

  ln -s pkgconf /tmp/bin/pkg-config
  sed -i '1s:^\(#! *\)/usr/bin/:\1/bin/:' /tmp/bin/*

  cd /src
  bash bootstrap
  auto-config --disable-intf-{bmc,free,imb,lipmi,serial} \
    IANADIR=/lib/ipmitool IANAUSERDIR=.local/lib/ipmitool
  make install DESTDIR=/dst
  rm -f /dst/bin/ipmievd /dst/lib/man/*/ipmievd.*
  rm -f /dst/lib/ipmitool/oem_ibm_sel_map
}
