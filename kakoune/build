check() {
  url https://github.com/mawww/kakoune/tags
  match version 2021.11.08 'tags/v([0-9.]+)\.tar'
}

prepare() {
  unpack kakoune-2022.09.10.tar.gz \
    https://github.com/mawww/kakoune/archive/67405393.tar.gz
  apply highlight.diff
  apply palette.diff
  apply paths.diff
  apply tabs.diff
  apply windowing.diff
  tree 6098d811a0b9de51b6571c8a65e6a17e77c8a4a1410f9de6b7f74c3cc038a45f
}

build() {
  make install CXX=c++ DESTDIR=/dst PREFIX= version=2022.09.10
  find /dst/lib/kak/{colors,kakrc,rc} -type f -exec sed -E -e '/^\s*#/d' \
    -e "s/^(([^'\"#]*|'[^']*'|\"([^\"\\]|\\\\.)*\")*)\\s+#\\s.*/\\1/" \
    -e 's/\s+$//' -e '/./,/^$/p' -i -n {} +
  find /dst/lib/kak/{colors,kakrc,rc} -type f | while read FILE; do
    sed -E -e '${/^$/d}' -e 's/rgb:[[:xdigit:]]{2}{3,4}/\L&/g' "$FILE" \
      | expand -i > "$FILE.tmp" && mv -f "$FILE.tmp" "$FILE"
  done
}
