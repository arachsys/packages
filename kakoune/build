check() {
  url https://github.com/mawww/kakoune/tags
  match version 2023.08.05 'tags/v([0-9.]+)\.tar'
}

prepare() {
   unpack kakoune-2024.01.22.tar.gz \
     https://github.com/mawww/kakoune/archive/6eb3d1ba.tar.gz
  apply balance.diff
  apply init.diff
  apply news.diff
  apply palette.diff
  apply paths.diff
  apply tabs.diff
  apply windowing.diff
  find -xtype l -delete
  tree f44bbff705d45e8afb1e88ccf851ad6d4c7504e9a3cf188e603a3112c5d66cb1
}

build() {
  if [[ $(c++ --version) == *clang* ]]; then
    COMPILER=clang++
    if enabled static; then
      LIBS='LDFLAGS+=-static LIBS+=-lunwind LIBS+=-lc++abi'
    fi
  else
    COMPILER=g++
    if enabled static; then
      LIBS='LDFLAGS+=-static'
    fi
  fi

  make install CXX=$COMPILER DESTDIR=/dst PREFIX= version=2024.01.22 $LIBS
  find /dst/lib/kak/{colors,kakrc,rc} -type f | while read FILE; do
    sed -E -e 's/rgb:[[:xdigit:]]{2}{3,4}/\L&/g' -e '/^\s*#/d' \
        -e "s/^(([^'\"#]*|'[^']*'|\"([^\"\\]|\\\\.)*\")*)\\s+#\\s.*/\\1/" \
        -e 's/\s+$//' -e '/./,/^$/p' -n "$FILE" | sed '${/^$/d}' \
      | expand -i > "$FILE.tmp" && mv -f "$FILE.tmp" "$FILE"
  done
  rm -f /dst/lib/kak/rc/tools/{*.pl,{git,man,patch}.kak}
}
