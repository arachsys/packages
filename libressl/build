check() {
  url https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/
  match version 3.8.2 'libressl-([0-9.]+)\.tar'
}

prepare() {
  unpack https://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-3.8.2.tar.gz
  apply dynamic.diff
  tree e4039c4940ce2b4a1fa1b454c5c845572ab9d385fb85112081891299f1b3fa31
}

build() {
  auto-config --enable-nc
  make && make install DESTDIR=/dst

  for LIB in /lib/shared/lib{crypto,ssl,tls}.so; do
    LIB=$(objdump -p $LIB | awk '$1 == "SONAME" { print $2 }')
    if [[ -f /lib/shared/$LIB ]] && [[ ! -f /dst/lib/$LIB ]]; then
      echo "Including compatibility ${LIB##*/} as soname has changed"
      cp -a -u /lib/shared/$LIB{,.*} /dst/lib/
    fi
  done | if [[ -n $(tee /dev/stderr) ]]; then
    echo "Rebuild dependants then libressl again to complete transition" >&2
  fi
}
