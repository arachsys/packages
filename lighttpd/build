require lua m4 pcre2 perl

check() {
  url https://www.lighttpd.net/
  match version 1.4.82 'lighttpd-([0-9.]+).tar'

  url https://ftp.gnu.org.uk/gnu/autoconf/
  match autoconf 2.72 'autoconf-([0-9.]+)\.tar'

  url https://ftp.gnu.org.uk/gnu/automake/
  match automake 1.18.1 'automake-([0-9.]+)\.tar'

  url https://ftp.gnu.org.uk/gnu/libtool/
  match libtool 2.5.4 'libtool-([0-9.]+)\.tar'

  url https://distfiles.ariadne.space/pkgconf/
  match pkgconf 2.5.1 'pkgconf-([0-9.]+)\.tar'
}

prepare() {
  unpack lighttpd-1.4.82.tar.xz \
    https://download.lighttpd.net/lighttpd/releases-1.4.x/lighttpd-1.4.82.tar.xz
  unpack -d tools/autoconf \
    https://ftp.gnu.org.uk/gnu/autoconf/autoconf-2.72.tar.xz
  unpack -d tools/automake \
    https://ftp.gnu.org.uk/gnu/automake/automake-1.18.1.tar.xz
  unpack -d tools/libtool \
    https://ftp.gnu.org.uk/gnu/libtool/libtool-2.5.4.tar.xz
  unpack -d tools/pkgconf \
    https://distfiles.ariadne.space/pkgconf/pkgconf-2.5.1.tar.xz
  apply paths.diff
  tree 74dedca1fb5dde3d36b92756d7df7a32164b117cd8c3498f4ad9e3ce6f96df1d
}

build() {
  export PATH=$PATH:/tmp/bin

  for TOOL in autoconf automake libtool pkgconf; do
    cd /src/tools/$TOOL
    auto-config --prefix=/tmp
    make install
   done

  ln -s pkgconf /tmp/bin/pkg-config
  sed -i '1s:^\(#! *\)/usr/bin/:\1/bin/:' /tmp/bin/*

  cd /src
  bash autogen.sh
  auto-config --libdir=/lib/lighttpd --with-pcre2 --with-openssl \
    --with-zstd PCRE2_CFLAGS=-I/lib/include PCRE2_LIBS=-lpcre2-8
  make install DESTDIR=/dst
  rm -f /dst/bin/lighttpd-angel
}
