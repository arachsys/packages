require go sqlite

check() {
  url https://github.com/foxcpp/maddy/releases
  match version 0.5.3 'tags/v([0-9.]+)\.tar'
}

prepare() {
  unpack maddy-0.5.3.tar.zstd \
    https://github.com/foxcpp/maddy/releases/download/v0.5.3/maddy-0.5.3-src.tar.zst
  apply paths.diff
  GOPATH=/tmp/go go mod vendor
  tree dc4e1ec148b721bbcc022b72d1e5b619d5f4c0e12c3e553f9cf2173b658519d3
}

build() {
  for CMD in maddy maddyctl; do
    GOPATH=/tmp/go HOME=/tmp go build -tags libsqlite3 -trimpath \
      -ldflags "-X \"github.com/foxcpp/maddy.Version=$(< .version)\"" \
      -o $CMD /src/cmd/$CMD
    install -D $CMD /dst/bin/$CMD
  done
  image - requires sqlite
}
