require go sqlite

check() {
  url https://github.com/foxcpp/maddy/releases
  match version 0.5.1 'tags/v([0-9.]+)\.tar'
}

prepare() {
  unpack maddy-0.5.1.tar.zstd \
    https://github.com/foxcpp/maddy/releases/download/v0.5.1/maddy-0.5.1-src.tar.zst
  apply paths.diff
  GOPATH=/tmp/go go mod vendor
  tree 0b591d0cdf75fdf60d39ccb6965851ba913be1c4d5be0f2715bd24365d38d312
}

build() {
  for CMD in maddy maddyctl; do
    GOPATH=/tmp/go HOME=/tmp go build -tags libsqlite3 -trimpath \
      -ldflags "-X \"github.com/foxcpp/maddy.Version=$(< .version)\"" \
      -o $CMD /src/cmd/$CMD
    install -D $CMD /dst/bin/$CMD
  done
  echo sqlite >>/dst/requirements
}
