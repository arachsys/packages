require go sqlite

check() {
  url https://github.com/foxcpp/maddy/releases
  match version 0.5.2 'tags/v([0-9.]+)\.tar'
}

prepare() {
  unpack maddy-0.5.2.tar.zstd \
    https://github.com/foxcpp/maddy/releases/download/v0.5.2/maddy-0.5.2-src.tar.zst
  apply paths.diff
  GOPATH=/tmp/go go mod vendor
  tree c29feaee6f412fa459c1b69f59b9ec9a588cd3a7bed3c545f6580093f86966f8
}

build() {
  for CMD in maddy maddyctl; do
    GOPATH=/tmp/go HOME=/tmp go build -tags libsqlite3 -trimpath \
      -ldflags "-X \"github.com/foxcpp/maddy.Version=$(< .version)\"" \
      -o $CMD /src/cmd/$CMD
    install -D $CMD /dst/bin/$CMD
  done
  echo sqlite >>/dst/requirements
}
