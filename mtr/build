enable setuid
require m4 perl

check() {
  url https://github.com/traviscross/mtr/tags
  match version 0.96 'v([0-9.]+)\.tar'

  url https://ftpmirror.gnu.org/gnu/autoconf/
  match autoconf 2.72 'autoconf-([0-9.]+)\.tar'

  url https://ftpmirror.gnu.org/gnu/automake/
  match automake 1.18.1 'automake-([0-9.]+)\.tar'

  url https://distfiles.ariadne.space/pkgconf/
  match pkgconf 2.5.1 'pkgconf-([0-9.]+)\.tar'
}

prepare() {
  unpack mtr-0.96.tar.gz \
    https://github.com/traviscross/mtr/archive/refs/tags/v0.96.tar.gz

  unpack -d tools/autoconf \
    https://ftpmirror.gnu.org/gnu/autoconf/autoconf-2.72.tar.xz
  unpack -d tools/automake \
    https://ftpmirror.gnu.org/gnu/automake/automake-1.18.1.tar.xz
  unpack -d tools/pkgconf \
    https://distfiles.ariadne.space/pkgconf/pkgconf-2.5.1.tar.xz

  apply cosmetic.diff
  apply prune.diff
  tree f1966ea14c45a4a2e979c16adc13bc4b8dfde06c2f18131ec95582b3c38e6c76
}

build() {
  export PATH=$PATH:/tmp/bin

  for TOOL in autoconf automake pkgconf; do
    cd /src/tools/$TOOL
    auto-config --prefix=/tmp
    make install
  done

  ln -s pkgconf /tmp/bin/pkg-config
  sed -i '1s:^\(#! *\)/usr/bin/:\1/bin/:' /tmp/bin/*

  cd /src
  bash bootstrap.sh
  auto-config
  make install DESTDIR=/dst
  rm -f -r /dst/lib/bash-completion
}
