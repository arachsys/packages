check() {
  url https://musl.libc.org/releases/
  match version 1.2.4 'musl-([0-9.]+)\.tar'
}

prepare() {
  unpack musl-20230824-79bdacff.tar.gz \
    https://git.musl-libc.org/cgit/musl/snapshot/musl-79bdacff.tar.gz
  apply nodata.diff
  apply paths.diff
  apply rrlimit.diff
  apply usage.diff
  tree 72b5949f073d9e9047082b3ab07c6d7e32156b1968df83a5744cce98d8d2d68a
}

build() {
  /src/configure --host=$CHOST --build=$CHOST --prefix= \
    --includedir='$(prefix)/lib/include' --libdir='$(prefix)/lib/shared' \
    --syslibdir='$(prefix)/lib' --disable-wrapper --enable-debug
  mkdir -p /dst/bin /dst/lib
  make install DESTDIR=/dst

  for UTIL in getconf getent iconv; do
    cc -isystem /dst/lib/include -L /dst/lib/shared -Os \
      /pkg/$UTIL.c -o /dst/bin/$UTIL
  done

  rm -f /dst/lib/ld-*.so.*
  ln -s shared/libc.so /dst/lib/ld.so
  install /pkg/ldd /dst/bin/ldd
}
