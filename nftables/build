require bison flex

check() {
  url https://www.netfilter.org/projects/nftables/downloads.html
  match nftables 1.1.6 'nftables-([0-9.]+)\.tar'

  url https://www.netfilter.org/projects/libmnl/downloads.html
  match libmnl 1.0.5 'libmnl-([0-9.]+)\.tar'

  url https://www.netfilter.org/projects/libnftnl/downloads.html
  match libnftnl 1.3.1 'libnftnl-([0-9.]+)\.tar'
}

prepare() {
  local NFP=https://www.netfilter.org/projects
  unpack $NFP/nftables/files/nftables-1.1.6.tar.xz
  unpack -d libmnl $NFP/libmnl/files/libmnl-1.0.5.tar.bz2
  unpack -d libnftnl $NFP/libnftnl/files/libnftnl-1.3.1.tar.xz
  apply histfile.diff
  tree 767141002a01e4b175f66cf96333ca8a0aa971ccbf69cb5a2a2c4d5544884dc6
}

build() {
  cd /src/libmnl
  /src/libmnl/configure --prefix=/tmp --disable-shared
  make install

  cd /src/libnftnl
  /src/libnftnl/configure --prefix=/tmp --disable-shared \
    LIBMNL_CFLAGS=-I/tmp/include LIBMNL_LIBS="-L/tmp/lib -lmnl"
  make install

  cd /src
  sed -i '/^SUBDIRS =/s/ \(examples\|files\)//g' Makefile.in
  auto-config --disable-shared --with-cli=readline --with-mini-gmp \
    LIBMNL_CFLAGS=-I/tmp/include LIBMNL_LIBS="-L/tmp/lib -lmnl" \
    LIBNFTNL_CFLAGS=-I/tmp/include LIBNFTNL_LIBS="-L/tmp/lib -lnftnl"
  make install DESTDIR=/dst
  rm -f -r /dst/lib/{include,lib*.a,lib*.la}
}
