mode autotools
require autotools bison libevent
enable setuid
enable setgid

check() {
  url https://www.opensmtpd.org/archives/
  match opensmtpd 6.8.0p2 'opensmtpd-([0-9.]+p[0-9]+)\.tar'

  url https://github.com/pullmoll/musl-fts/tags
  match musl-fts 1.2.7 'tags/v([0-9.]+)\.tar'
}

prepare() {
  unpack opensmtpd-20230517-d8d26051.tar.gz \
    https://github.com/opensmtpd/opensmtpd/archive/d8d26051.tar.gz
  unpack -d fts musl-fts-1.2.7.tar.gz \
    https://github.com/pullmoll/musl-fts/archive/v1.2.7.tar.gz
  apply declare.diff
  apply english.diff
  apply forward.diff
  apply paths.diff
  tree 88c4c6c961f398da5c4d4d764317f1ab58f578c75ca462e2c29de22a415fd66a
}

pre-config() {
  echo '#define HAVE_DECL_MAX 1' >fts/config.h
  cc -Ifts -O2 -Wall -c fts/fts.c -o fts/fts.o
  ar rcs fts/libfts.a fts/fts.o
  autoreconf -i
}

config-extra --sysconfdir=/etc/mail --with-path-{pidfile,socket}=/run \
  --with-path-{empty=/run/empty,mbox=/var/mail,queue=/var/lib/smtpd} \
  --with-{group-queue,user-queue,user-smtpd}=mail \
  --with-libfts CFLAGS=-I/src/fts LDFLAGS=-L/src/fts

post-install() {
  ln -s smtpctl /dst/bin/sendmail
  image - requires libevent
}
