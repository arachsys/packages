enable setuid
require libedit

check() {
  url https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/
  match version 10.2p1 'openssh-([0-9.]+p[0-9]+)\.tar'
}

prepare() {
  unpack https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/openssh-10.2p1.tar.gz
  apply agent.diff
  apply chroot.diff
  apply config.diff
  apply home.diff
  apply mktemp.diff
  apply self.diff
  apply shell.diff
  tree de88e101b2df3e20e7b7a6aced89e51050f1b2321da686ae7981d5197702fbc5
}

build() {
  auto-config --sysconfdir=/etc/ssh --libexecdir=/lib/openssh \
    --disable-lastlog --disable-{u,w}tmp{,x} --with-4in6 \
    --with-default-path=/bin --with-libedit --with-pid-dir=/run \
    --with-privsep-{path=/run/empty,user=ssh} --with-xauth=/bin/xauth \
    --without-zlib-version-check
  sed -i '/^CFLAGS=/s/ -fzero-call-used-regs=all//' **/Makefile
  sed -i '/#define USE_BTMP/d' config.h
  make && make install-nokeys DESTDIR=/dst
  chmod u+rw,go+r /dst/lib/openssh/*
}
