enable rpaths
require bison flex perl

check() {
  url https://ftp.postgresql.org/pub/source/
  match version 18.0 'v([0-9.]+)/'
}

prepare() {
  unpack https://ftp.postgresql.org/pub/source/v18.0/postgresql-18.0.tar.bz2
  apply locale.diff
  tree dc70d9f6b339c3064baca8212051fc750facaa544e206d73797c6f4d5be958c8
}

build() {
  PREFIX=/lib/postgres/18
  auto-config --prefix=$PREFIX --libdir=$PREFIX/lib/shared --disable-rpath \
    --with-ssl=openssl --with-zstd --without-icu \
    ZSTD_CFLAGS=-I/lib/include ZSTD_LIBS=-lzstd
  for DIR in . contrib/pg_trgm contrib/pgcrypto; do
    make install -C $DIR DESTDIR=/dst \
      LDFLAGS_EX=-Wl,-rpath,'\$$ORIGIN/../lib/shared',--enable-new-dtags
  done

  cp -a /lib/shared/lib{crypto,ssl}.so.* /dst$PREFIX/lib/shared/
  echo "listen_addresses = ''" >/dst$PREFIX/lib/postgresql.conf.sample
  echo "local all all trust" >/dst$PREFIX/lib/pg_hba.conf.sample
  : >/dst$PREFIX/lib/pg_ident.conf.sample
  : >/dst$PREFIX/lib/pg_service.conf.sample
  rm -f /dst$PREFIX/lib/psqlrc.sample
}
