mode autotools
require libffi sqlite

check() {
  url https://www.python.org/downloads/source/
  match version 3.11.1 'Python-([0-9.]+)\.tar'
}

prepare() {
  unpack python-3.11.1.tar.xz \
    https://www.python.org/ftp/python/3.11.1/Python-3.11.1.tar.xz
  apply checked.diff
  apply getpath.diff
  apply history.diff
  apply libressl.diff
  apply paths.diff
  sed -i '1s_^#!.*_#!/bin/python3_' Misc/python-config.in **/*.py
  tree 5e21d74f6d72cee257fc0860b971b74e90f165d1dfe3674ec656f17bfd1ee512
}

config-extra --enable-optimizations --enable-shared --with-ensurepip=no \
  --with-lto --with-openssl=/lib --with-ssl-default-suites=openssl \
  CFLAGS="-fno-semantic-interposition -DTHREAD_STACK_SIZE=0x100000" \
  LDFLAGS=-fno-semantic-interposition

post-install() {
  LD_LIBRARY_PATH=/dst/lib /dst/bin/python3 -m venv /tmp/venv
  LD_LIBRARY_PATH=/dst/lib /tmp/venv/bin/pip install wheel

  cd /dst/lib/python/ensurepip/_bundled
  for WHEEL in pip-*.whl setuptools-*.whl; do
    LD_LIBRARY_PATH=/dst/lib /tmp/venv/bin/python -m wheel unpack $WHEEL
  done

  sed -i '/^disable_pip_version_check/,/^)/s/default=False/default=True/' \
    pip-*/pip/_internal/cli/cmdoptions.py

  sed -e 's:\$py_version_short::g' -e 's:\$abiflags::g' \
    -e 's:\$base/include:\$base/lib/include:g' \
    -i setuptools-*/setuptools/_distutils/command/install.py

  for WHEEL in pip-*/ setuptools-*/; do
    LD_LIBRARY_PATH=/dst/lib /tmp/venv/bin/python -m wheel pack $WHEEL
    rm -f -r $WHEEL
  done

  LD_LIBRARY_PATH=/dst/lib /dst/bin/python3 -m ensurepip

  rm -f -r /dst/bin/{idle*,python*-config} /dst/lib/python/**/test{,s}/ \
    /dst/lib/python/{__phello__.foo.py,dbm,idlelib,LICENSE.txt} \
    /dst/lib/python/{turtle*,__pycache__/turtle.*,tkinter,venv/scripts}

  mv -f /dst/bin/2to3-* /dst/bin/2to3
  mv -f /dst/bin/pydoc3.* /dst/bin/pydoc3 && ln -s pydoc3 /dst/bin/pydoc
  mv -f /dst/bin/python3.* /dst/bin/python3 && ln -s python3 /dst/bin/python
  rm -f /dst/bin/pip3.* && ln -s pip3 /dst/bin/pip

  sed -i '1s_^#!.*_#!/bin/python3_' /dst/bin/{2to3,pydoc3,pip3}

  image - requires libffi
}
