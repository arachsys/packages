mode autotools
require libffi sqlite

check() {
  url https://www.python.org/downloads/source/
  match version 3.10.3 'Python-([0-9.]+)\.tar'
}

prepare() {
  unpack python-3.10.3.tar.xz \
    https://www.python.org/ftp/python/3.10.3/Python-3.10.3.tar.xz
  apply getpath.diff
  apply history.diff
  apply libressl.diff
  apply musl.diff
  apply paths.diff
  tree 84c62c53c7fec0df114a12ba6f2a61fcbdee9f58fcef35c9101edc3aadae86c0
}

config-extra --enable-optimizations --enable-shared --with-dbmliborder= \
  --with-ensurepip=install --with-lto --with-openssl=/lib \
  CFLAGS="-fno-semantic-interposition -DTHREAD_STACK_SIZE=0x100000" \
  LDFLAGS=-fno-semantic-interposition

post-install() {
  rm -f -r /dst/lib/python/{,*/}{test,tests}/ \
    /dst/lib/python/{__phello__.foo.py,dbm,idlelib,LICENSE.txt} \
    /dst/lib/python/{turtle*,tkinter,__pycache__/turtle.*} \
    /dst/lib/python/venv/scripts/*/!(activate) \
    /dst/bin/{2to3,easy_install*,idle*,pip3,pydoc3,python3,python*-config}
  mv /dst/lib/python/venv/scripts/common/activate{,.sh}
  mv /dst/bin/2to3-3.10 /dst/bin/2to3
  mv /dst/bin/pip3.10 /dst/bin/pip
  mv /dst/bin/pydoc3.10 /dst/bin/pydoc
  mv /dst/bin/python3.10 /dst/bin/python3
  ln -s python3 /dst/bin/python
  sed -i '1s_^#!.*_#!/bin/python3_' /dst/bin/2to3 /dst/bin/pip \
    /dst/bin/pydoc /dst/lib/python/config-3*/python-config.py

  sed -i '/^disable_pip_version_check/,/^)/s/default=False/default=True/' \
    /dst/lib/python/site-packages/pip/_internal/cli/cmdoptions.py
  LD_LIBRARY_PATH=/dst/lib /dst/bin/python -m compileall \
    /dst/lib/python/site-packages/pip/_internal/cli/cmdoptions.py

  image - requires libffi
}
