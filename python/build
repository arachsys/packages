mode autotools
require libffi sqlite

check() {
  url https://www.python.org/downloads/source/
  match version 3.9.7 'Python-([0-9.]+)\.tar'
}

prepare() {
  unpack python-3.9.7.tar.xz \
    https://www.python.org/ftp/python/3.9.7/Python-3.9.7.tar.xz
  apply getpath.diff
  apply fakepkg.diff
  apply history.diff
  apply musl.diff
  apply paths.diff
  tree 960c174db78ebd322a8d3d39117c4dcca7129eb446ee206cf310d5a5e1a77741
}

config-extra --enable-{ipv6,optimizations,shared} --with-ensurepip=install \
  --with-{computed-gotos,dbmliborder=,lto} PKG_CONFIG=/src/fake-pkg-config \
  CFLAGS="$CFLAGS -fno-semantic-interposition" \
  LDFLAGS="$LDFLAGS -fno-semantic-interposition"

post-install() {
  rm -f -r /dst/lib/python/{,*/}{test,tests}/ \
    /dst/lib/python/{__phello__.foo.py,dbm,idlelib,LICENSE.txt} \
    /dst/lib/python/{turtle*,tkinter,__pycache__/turtle.*} \
    /dst/lib/python/venv/scripts/*/!(activate) \
    /dst/bin/{2to3,easy_install*,idle*,pip3,pydoc3,python3,python*-config}
  mv /dst/lib/python/venv/scripts/common/activate{,.sh}
  mv /dst/bin/2to3-3.9 /dst/bin/2to3
  mv /dst/bin/pip3.9 /dst/bin/pip
  mv /dst/bin/pydoc3.9 /dst/bin/pydoc
  mv /dst/bin/python3.9 /dst/bin/python3
  ln -s python3 /dst/bin/python
  sed -i '1s_^#!.*_#!/bin/python3_' /dst/bin/2to3 /dst/bin/pip \
    /dst/bin/pydoc /dst/lib/python/config-3*/python-config.py

  sed -i '/^disable_pip_version_check/,/^)/s/default=False/default=True/' \
    /dst/lib/python/site-packages/pip/_internal/cli/cmdoptions.py
  LD_LIBRARY_PATH=/dst/lib /dst/bin/python -m compileall \
    /dst/lib/python/site-packages/pip/_internal/cli/cmdoptions.py

  echo libffi >>/dst/requirements
}
