mode autotools
require libffi sqlite

check() {
  url https://www.python.org/downloads/source/
  match version 3.10.8 'Python-([0-9.]+)\.tar'
}

prepare() {
  unpack python-3.10.8.tar.xz \
    https://www.python.org/ftp/python/3.10.8/Python-3.10.8.tar.xz
  apply getpath.diff
  apply history.diff
  apply libressl.diff
  apply musl.diff
  apply paths.diff
  tree 22fb0f1fa2cd879464b54e7faf58791316548e8377a9c047a826e9dc4654efde
}

config-extra --enable-optimizations --enable-shared --with-dbmliborder= \
  --with-ensurepip=no --with-lto --with-openssl=/lib \
  CFLAGS="-fno-semantic-interposition -DTHREAD_STACK_SIZE=0x100000" \
  LDFLAGS=-fno-semantic-interposition

post-install() {
  LD_LIBRARY_PATH=/dst/lib /dst/bin/python3 -m venv /tmp/venv
  LD_LIBRARY_PATH=/dst/lib /tmp/venv/bin/pip install wheel

  cd /dst/lib/python/ensurepip/_bundled
  for WHEEL in pip-*.whl setuptools-*.whl; do
    LD_LIBRARY_PATH=/dst/lib /tmp/venv/bin/python -m wheel unpack $WHEEL
  done

  sed -i '/^disable_pip_version_check/,/^)/s/default=False/default=True/' \
    pip-*/pip/_internal/cli/cmdoptions.py

  sed -e 's:\$py_version_short::g' -e 's:\$abiflags::g' \
    -e 's:\$base/include:\$base/lib/include:g' \
    -i setuptools-*/setuptools/_distutils/command/install.py

  for WHEEL in pip-*/ setuptools-*/; do
    LD_LIBRARY_PATH=/dst/lib /tmp/venv/bin/python -m wheel pack $WHEEL
    rm -f -r $WHEEL
  done

  LD_LIBRARY_PATH=/dst/lib /dst/bin/python3 -m ensurepip

  rm -f -r /dst/bin/{idle*,python*-config} /dst/lib/python/**/test{,s}/ \
    /dst/lib/python/{__phello__.foo.py,dbm,idlelib,LICENSE.txt} \
    /dst/lib/python/{turtle*,__pycache__/turtle.*,tkinter,venv/scripts}

  mv -f /dst/bin/2to3-* /dst/bin/2to3
  mv -f /dst/bin/pip3.* /dst/bin/pip3 && ln -s pip3 /dst/bin/pip
  mv -f /dst/bin/pydoc3.* /dst/bin/pydoc3 && ln -s pydoc3 /dst/bin/pydoc
  mv -f /dst/bin/python3.* /dst/bin/python3 && ln -s python3 /dst/bin/python

  sed -i '1s_^#!.*_#!/bin/python3_' /dst/bin/2to3 /dst/bin/pip3 \
    /dst/bin/pydoc3 /dst/lib/python/config-3*/python-config.py

  image - requires libffi
}
