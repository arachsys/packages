mode autotools
require libffi

check() {
  url https://www.ruby-lang.org/en/downloads/
  match version 3.1.2 'ruby-([0-9.]+)\.tar'
}

prepare() {
  unpack https://cache.ruby-lang.org/pub/ruby/3.1/ruby-3.1.2.tar.gz
  apply extconf.diff
  apply irb.diff
  apply libressl.diff
  apply paths.diff
  apply plain.diff
  tree 2f12da82a7b47ff37ff6fc4e444324889a908af00d217a19e6894c32c88c663d
}

config-extra --disable-install-doc  --disable-rpath --enable-shared \
  --with-ridir=/lib/ruby/doc --with-ruby{arch,}hdrdir=/lib/include \
  --with-ruby{arch,lib}prefix=/lib/ruby \
  --with-{site,vendor}{archdir,archhdrdir,dir,hdrdir}=no

post-install() {
  rm -f /dst/lib/include/rb_mjit_min_header-*.h
  image - requires libffi
}
