require python rust

prepare() {
  unpack https://static.rust-lang.org/dist/rustc-1.54.0-src.tar.gz
  apply curl.patch
  apply libressl.patch
  apply nocred.patch
  apply system.patch
  apply target.patch
  sed -i 's/\("files":{\)[^}]*/\1/' \
    vendor/{curl-sys,openssl-sys}/.cargo-checksum.json
  tree aa2c8732aa7232f7d3467850547e358932a36d216ae7e171ff12920b2a1fe994
}

build() {
  /src/configure --prefix= --disable-codegen-tests --disable-dist-src \
     --disable-docs --disable-manage-submodules --disable-ninja \
     --disable-rpath --enable-extended --enable-local-rust \
     --enable-locked-deps --enable-use-libcxx --enable-vendor \
     --dist-compression-formats=gz --llvm-libunwind=system \
     --llvm-config=$(echo /lib/llvm/*/bin/llvm-config) --local-rust-root= \
     --tools=analysis,cargo,clippy,rust-analyzer,rustfmt

  DESTDIR=/dst OPENSSL_INCLUDE_DIR=/lib/include OPENSSL_LIB_DIR=/lib/shared \
    RUSTFLAGS="-Lnative=/lib/shared -Lnative=/lib/static" python x.py install
  rm -f -r /dst/{bin/rust-*db*,etc,lib/rustlib/!($CHOST),share}
}
