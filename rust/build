require python rust

check() {
  url https://github.com/rust-lang/rust/tags
  match version 1.69.0 'tags/([0-9.]+)\.tar'
}

prepare() {
  unpack https://static.rust-lang.org/dist/rustc-1.69.0-src.tar.gz
  sed -i -E 'H;1h;$!d;x;s/("files"\s*:\s*\{)("([^"\\]|\\.)*"|[^"}])*/\1/' \
    vendor/*/.cargo-checksum.json
  apply curl.diff
  apply lfs64.diff
  apply libexec.diff
  apply libressl.diff
  apply nocred.diff
  apply system.diff
  apply target.diff
  apply version.diff
  tree 6a76373e47c82d1fb96dba46d3f5c8fa793e307033b1777201bb643acf645fa4
}

build() {
  /src/configure --prefix= --disable-codegen-tests --disable-dist-src \
     --disable-docs --disable-manage-submodules --disable-ninja \
     --disable-rpath --enable-extended --enable-local-rust \
     --enable-locked-deps --enable-use-libcxx --enable-vendor \
     --dist-compression-formats=gz --llvm-libunwind=system \
     --llvm-config=$(echo /lib/llvm/*/bin/llvm-config) --local-rust-root= \
     --release-channel=stable --set=llvm.static-libstdcpp=false \
     --tools=analysis,cargo,clippy,rust-analyzer,rustfmt

  DESTDIR=/dst OPENSSL_INCLUDE_DIR=/lib/include OPENSSL_LIB_DIR=/lib/shared \
    python x.py install
  rm -f /dst/bin/{rust-*db*,rust-analyzer-proc-macro-srv}
  rm -f -r /dst/{etc,lib/rustlib/!($CHOST),share}
}
