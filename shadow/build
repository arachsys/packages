enable setuid setgid

check() {
  url https://github.com/shadow-maint/shadow/tags
  match version 4.19.0 'tags/([0-9.]+)\.tar'
}

prepare() {
  unpack https://github.com/shadow-maint/shadow/releases/download/4.19.0/shadow-4.19.0.tar.xz
  apply backups.diff
  apply defaults.diff
  apply nss.diff
  apply paths.diff
  tree 8d12a4645f942e225c1a6bd710fdd9e6e8a4a7a033a16ec849f32c8c6ee477af
}

build() {
  auto-config --disable-logind --disable-shared --with-bcrypt \
    --without-{audit,btrfs,libbsd,libpam,sssd}
  sed -e 's:^\(#define FAILLOG_FILE\).*:\1 "/dev/null":' \
      -e 's:^\(#define LASTLOG_FILE\).*:\1 "/dev/null":' \
      -e 's:^\(#define _UTMP_FILE\).*:\1 "/dev/null":' \
      -e 's:^\(#define _WTMP_FILE\).*:\1 "/dev/null":' \
      -i config.h
  make install DESTDIR=/dst
  chgrp shadow /dst/bin/{chage,expiry}
  chmod u-s,g+s /dst/bin/{chage,expiry}
  rm -f /dst/bin/{chfn,faillog,groups,lastlog,logoutd}
  rm -f /dst/lib/man/man*/{chfn,faillog,groups,lastlog,logoutd}.*
  rm -f -r /dst/lib/include /dst/lib/*.a
}
