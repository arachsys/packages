mode autotools
enable setuid setgid

check() {
  url https://git.kernel.org/pub/scm/utils/util-linux/util-linux.git/refs/
  match version 2.38 'util-linux-([0-9.]+)\.tar'
}

prepare() {
  unpack https://www.kernel.org/pub/linux/utils/util-linux/v2.38/util-linux-2.38.tar.xz
  apply logger.diff
  apply paths.diff
  tree 0e6baf3a75e7055cb6878aa5e129bdb1100146f68cfbcff740cc05568dc2dcb2
}

config-extra --disable-{bfs,chfn-chsh,cramfs,last,login,lslogins,mesg} \
  --disable-{minix,more,newgrp,nologin,pivot_root,switch_root,su,ul} \
  --disable-{use-tty-group,utmpdump,vipw,wall,whereis} \
  --enable-{fs-paths-default=/bin,shared,sulogin-emergency-mount} \
  ADJTIME_PATH=/var/lib/adjtime

post-config() {
  find . -type f -name Makefile | while read FILE; do
    sed -i 's:^\(usrsbin_execdir *=\).*:\1 /bin:' $FILE
    sed -i 's:^\(usrlib_execdir *=\).*:\1 /lib:' $FILE
    sed -i 's:^\(pkgconfigdir *=\).*:\1 /lib/pkgconfig:' $FILE
  done
  sed -i 's:/sbin:/bin:g' po/*.{gmo,po,pot}
  sed -i 's:/etc/mtab:/run/mtab:g' po/*.{gmo,po,pot}
  sed -i 's:/etc/adjtime:/var/lib/adjtime:g' po/*.{gmo,po,pot}
}

post-install() {
  rm -f /dst/bin/{chkdupexec,isosize,mcookie}
  rm -f -r /dst/lib/{getopt,bash-completion}
  find /dst/bin -lname setarch -delete
}
